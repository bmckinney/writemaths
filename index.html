<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Write maths, see maths!</title>

		<!-- MathJax -->
		<SCRIPT SRC="http://cdn.mathjax.org/mathjax/latest/MathJax.js">
		  MathJax.Hub.Config({
			extensions: ['tex2jax.js',"TeX/AMSmath.js","TeX/AMSsymbols.js"],
			tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]},
			jax: ["input/TeX","output/HTML-CSS"],
			displayAlign: "center",
			displayIndent: "0.1em",
			showProcessingMessages: false
		  });
	  	</SCRIPT>

		<!-- jQuery -->
		<script type="text/javascript" src="jquery-1.6.js"></script>
		<script type="text/javascript" src="jquery.oembed.js"></script>
		<script type="text/javascript" src="jquery-ui-1.8.12.custom.min.js"></script>

		<!-- Numbas JME maths compiler/evaluator/renderer -->
		<script type="text/javascript" src="jme.js"></script>

		<!-- jsxGraph -->
		<script type="text/javascript" src="jsxgraphcore.js"></script>
		<link rel="stylesheet" type="text/css" href="jsxgraph.css" />

		<!-- generic writemaths code -->
		<script type="text/javascript" src="writemaths.js"></script>

		<!-- init writemaths area, hook up buttons -->
		<script language="javascript">
			var wm;
			$(window).ready(function() {
				var saveName = 'help';
				if(window.location && window.location.search)
				{
					saveName = window.location.search.slice(1);
				}

				//switch page
				$('#switch').submit(function(e) {
					e.stopPropagation();
					e.preventDefault();
					var name = $(this).find('input').val();
					changeSaveName(name);
					wm.load();
					$(this).find('input').blur();
				});

				$(window).bind('popstate',function(e) {
					var name = window.location.search.slice(1);
					if(name)
						changeSaveName(name,true);
					wm.load();
				});

				function changeSaveName(name,nopush)
				{
					wm.setState('');
					if(!nopush && name!=saveName)
					{
						if(history && history.pushState)
							history.pushState({name: name},'['+name+'] Write maths, see maths!','?'+name);
						else
							document.location = '?'+name;
					}
					wm.saveName = saveName = name;
					$('#switch input, #saveas input').val(saveName);
					$('#switch input').val(saveName);
					var url = window.location.href;
					$('#url').attr('href',url).html(url);

					//recent pages auto-complete doodah
					var recent;
					try {
						recent = JSON.parse(localStorage['writemathsrecent']) || [];
					}
					catch(e) {
						recent = [];
					}
					if( (i=recent.indexOf(saveName)) >= 0 )
					{
						recent.splice(i,1);
					}
					if(!saveName.match(/tmp\d+/))
						recent.splice(0,0,saveName);
					recent = recent.slice(0,6);

					localStorage['writemathsrecent'] = JSON.stringify(recent);

					$('#switch input')
						.autocomplete({
							source: recent,
							minLength: 0,
							delay: 0,
							select: function(event,ui) { $(this).val(ui.item.value).submit(); }
						})
						.click(function() {

						})
						.focus(function() { this.select(); $(this).autocomplete('search','')})
						.mouseup(function(){ return false; })
					;
				}

				//save current page under different name
				$('#saveas').submit(function(e) {
					e.stopPropagation();
					e.preventDefault();
					changeSaveName($(this).find('input').val());
					wm.saveState();
				});

				$('#newpage').click(function() {
					name = 'tmp'+(new Date()).getTime();
					changeSaveName(name);
				});

				document.title = '['+saveName+'] Write maths, see maths!';

				wm = new WriteMaths('#writemaths',{
					display: '#printout',
					saveName: saveName
				});

				changeSaveName(saveName);

				$('#clear').click(function() {
					wm.setState('');
					wm.saveState();
				});
				$('#togglehtml').click(function() {
					wm.getHTML();
					var t = $('#printout').toggle().is(':visible') ? 'Hide HTML' : 'Show HTML';
					$('#togglehtml').val(t);
				});
			});
		</script>

		<link rel="stylesheet" type="text/css" href="jquery-ui.css" />
		<link rel="stylesheet" type="text/css" href="reset.css" />
		<link rel="stylesheet" type="text/css" href="typography.css" />
		<link rel="stylesheet" type="text/css" href="writemaths.css" />

	</head>
	<body>
		<div id="nav">
			<span>This page's URL: <a id="url"></a></span>
			<a href="?help">Help</a>
			<a id="newpage">New Page</a>
			<form id="switch">
				<label for="input">Load Page: </label><input id="input" type="text"></input>
			</form>
			<form id="saveas">
				<label for="input">Save as: </label><input id="input" type="text"></input>
			</form>
		</div>
		<div id="writemaths">
		</div>
		<div id="controls">
			<input type="button" value="Clear" id="clear"/>
			<input type="button" value="Show HTML" id="togglehtml"/>
			<textarea id="printout" style="display:none;"></textarea>
		</div>
	</body>
</html>
